# Maintainer: Alucryd <alucryd at gmail dot com>

pkgname=pantheon-session-bzr
pkgver=55
pkgrel=1
pkgdesc="Session Manager for Pantheon."
arch=('any')
url="https://code.launchpad.net/~elementary-os/elementaryos/pantheon-xsession-settings"
license=('GPL3')
groups=('pantheon')
depends=('gnome-session' 'gnome-settings-daemon' 'pantheon-dock-bzr' 'slingshot-bzr' 'gala-bzr' 'pantheon-files-bzr' 'wingpanel-bzr' 'pantheon-wallpaper-bzr' 'cerbere-bzr')
makedepends=('bzr' 'vala' 'cmake')
conflicts=('pantheon-session')

#_bzrtrunk=lp:pantheon-session
#_bzrmod=pantheon-session
_bzrtrunk=lp:~elementary-os/elementaryos/pantheon-xsession-settings
_bzrmod=pantheon-xsession-settings

build() {
	msg "Connecting to Bazaar server...."

	if [ -d $_bzrmod ]; then
		cd $_bzrmod && bzr pull $_bzrtrunk -r $pkgver && cd ..
		msg "The local files are updated."
	else
		bzr branch $_bzrtrunk $_bzrmod -r $pkgver
	fi

	msg "BZR checkout done or server timeout"
	msg "Starting make..."

#	cd ${_bzrmod}
#	sed -i 's|env python|env python2|g' waf wscript
#	./waf configure --prefix=/usr
#	./waf build
}

package() {
	cd "${srcdir}/${_bzrmod}"
#	./waf install -f --destdir="${pkgdir}"
#	sed -i 's|wm=compiz|wm=gala|g' "${pkgdir}/usr/share/pantheon-session/pantheon.session"
	mkdir -p "${pkgdir}/etc/xdg"
	mkdir -p "${pkgdir}/usr/share/xsessions"
	mkdir -p "${pkgdir}/usr/share/gnome-session/sessions"
	mkdir "${pkgdir}/usr/share/pantheon"
	mv autostart "${pkgdir}/etc/xdg/"
	mv debian/pantheon.desktop "${pkgdir}/usr/share/xsessions/"
	mv debian/pantheon.session "${pkgdir}/usr/share/gnome-session/sessions/"
	mv gconf "${pkgdir}/usr/share/GConf"
	mv unity-greeter "${pkgdir}/usr/share/"
	mv applications "${pkgdir}/usr/share/pantheon/"
	rm "${pkgdir}/etc/xdg/autostart/cerbere.desktop"

# Fix permissions
	find "${pkgdir}" -type d | xargs chmod 755
	find "${pkgdir}" -type f | xargs chmod 644
}
